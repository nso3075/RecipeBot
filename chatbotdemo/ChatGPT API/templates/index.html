<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Campus Food Chatbot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap CSS for styling -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">

  <!-- FontAwesome for icons (optional) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">

  <!-- Highlight.js for optional code highlighting in chat -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/a11y-dark.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>

  <!-- Custom Stylesheet -->
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body style="background-color: #1e1e2f; color: white;">

  <!-- Main Chatbot Container -->
  <div class="container mt-5" style="max-width: 900px;">
    <h1 class="text-white mb-4">Campus Food Chatbot</h1>

    <!-- Chat Box -->
    <div class="chat-box p-4 mb-4" style="background:#2a2a3d; border-radius:10px; max-height:750px; min-height:500px; overflow-y:auto; position:relative;">
      <!-- Messages dynamically added here -->
      
      <!-- Loading spinner (hidden by default) -->
      <div id="loading" style="display:none; text-align:center; margin-top:20px;">
        <div class="spinner-border text-primary" role="status">
          <span class="sr-only">Loading...</span>
        </div>
        <div style="margin-top:10px;">üë®‚Äçüç≥ Cooking up something delicious...</div>
      </div>
    </div>

    <!-- User Message Input -->
    <div class="form-group">
      <textarea class="form-control" id="message-input" rows="3" placeholder="Type your ingredients or question here..."></textarea>
    </div>

    <!-- Send Button -->
    <button class="btn btn-primary" id="send-btn">Send</button>
  </div>

  <!-- --- Frontend JavaScript Logic --- -->
  <script>
    const chatBox = document.querySelector(".chat-box");
    const messageInput = document.querySelector("#message-input");
    const sendBtn = document.querySelector("#send-btn");

    // Function to add a message (user or bot) to the chat window
    function addMessage(message, isUser) {
      const div = document.createElement("div");
      div.classList.add("mt-3", "p-3", "rounded", isUser ? "user-message" : "bot-message");

      const icon = isUser
        ? "{{ url_for('static', filename='images/henry.jpg') }}"   // User icon
        : "{{ url_for('static', filename='images/gpt.jpg') }}";    // Bot icon

      div.innerHTML = `
        <img src="${icon}" style="width:32px;height:32px;border-radius:50%;margin-right:8px;">
        <div>${message}</div>
      `;
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;  // Always scroll to newest message
    }

    // Function to send the user's input to the backend
    function sendMessage() {
      const message = messageInput.value.trim();
      if (!message) return;

      addMessage(message, true);  // Show user's own message
      messageInput.value = "";    // Clear the input field
      document.getElementById("loading").style.display = "block";  // Show loading animation

      // Send POST request to Flask API
      fetch("/api", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message })
      })
      .then(res => res.json())
      .then(data => {
        document.getElementById("loading").style.display = "none";  // Hide loading spinner

        const div = document.createElement("div");
        div.classList.add("mt-3", "p-3", "rounded", "bot-message");

        // Build bot reply with optional image and audio
        div.innerHTML = `
          <img src="{{ url_for('static', filename='images/gpt.jpg') }}" style="width:32px;height:32px;border-radius:50%;margin-right:8px;">
          <div>${data.text}</div>
          ${data.image_url ? `<img src="${data.image_url}" alt="Recipe Image" style="width:300px;height:auto;display:block;margin:15px auto;border-radius:12px;">` : ""}
          ${data.audio_base64 ? `<audio controls style="margin-top:10px;"><source src="data:audio/mp3;base64,${data.audio_base64}" type="audio/mp3"></audio>` : ""}
        `;
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
        messageInput.focus();  // Focus back to input for fast chatting
      })
      .catch(error => {
        console.error("Error:", error);
        document.getElementById("loading").style.display = "none";
        alert("There was an error processing your request.");
      });
    }

    // Function to show the initial welcome message when page loads
    function initialBotMessage() {
      const welcomeMessage = "Hi! I'm your campus food guide. Please send me the ingredients you have, and I'll create a meal idea for you!";
      addMessage(welcomeMessage, false);
    }

    // Event Listeners
    sendBtn.addEventListener("click", sendMessage);
    messageInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();  // Prevent newline on Enter
        sendMessage();
      }
    });

    // Optional: Highlight code snippets every second if they appear
    setInterval(() => {
      document.querySelectorAll("pre code").forEach(block => {
        hljs.highlightElement(block);
      });
    }, 1000);

    // Auto-run initial welcome message on page load
    window.onload = initialBotMessage;
  </script>

</body>
</html>